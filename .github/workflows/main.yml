name: Weekly Traffic Report

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

jobs:
  collect-traffic:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      REPO_OWNER: ${{ github.repository_owner }}
      REPO_NAME: ${{ github.event.repository.name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史记录
    
    - name: Check directory structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Creating .github/traffic directory if missing"
        mkdir -p .github/traffic
        echo "Creating traffic_data.csv if missing"
        touch .github/traffic/traffic_data.csv
        echo "Directory structure:"
        ls -R .github
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.x"
    
    - name: Install dependencies
      run: pip install requests
    
    - name: Run traffic collector
      run: |
        echo "Running traffic collector..."
        cd .github/traffic
        python traffic_collector.py
    
    - name: Commit and push changes
      run: |
        # 配置 Git
        git config user.name "github-actions"
        git config user.email "actions@users.noreply.github.com"
        
        # 添加更改
        git add .github/traffic/traffic_data.csv
        
        # 检查是否有实际更改
        if git diff-index --quiet HEAD --; then
          echo "No changes to commit"
        else
          git commit -m "Update traffic data"
          git push "https://${{ github.actor }}:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git"
        fi
