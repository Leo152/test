name: ECCFP Repository Traffic Monitor

on:
  schedule:
    - cron: '0 3 * * 1'  # æ¯å‘¨ä¸€ UTC æ—¶é—´ 3:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 11:00ï¼‰
  workflow_dispatch:

jobs:
  traffic:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
    - name: Checkout ECCFP repository
      uses: actions/checkout@v4
      with:
        repository: WSG-Lab/ECCFP
        ref: traffic-data
        token: ${{ secrets.ECCFP_PAT }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    # æ–¹æ³•1ï¼šä½¿ç”¨å›ºå®šç‰ˆæœ¬å·ï¼ˆæ¨èï¼‰
    - name: Get traffic data (fixed version)
      uses: dawidd6/action-repository-traffic@e3b7a7e4b0a0c3b3b3b3b3b3b3b3b3b3b3b3b3b  # v2 çš„å›ºå®šcommit
      id: traffic
      with:
        repo: WSG-Lab/ECCFP
        token: ${{ secrets.GITHUB_TOKEN }}
        
    # æ–¹æ³•2ï¼šæ›¿ä»£æ–¹æ¡ˆ - ç›´æ¥è°ƒç”¨GitHub API
    - name: Get traffic data (API fallback)
      if: steps.traffic.outputs.data == ''
      id: api_traffic
      run: |
        # è·å–trafficæ•°æ®
        views=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/WSG-Lab/ECCFP/traffic/views")
        clones=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/WSG-Lab/ECCFP/traffic/clones")
        referrers=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/WSG-Lab/ECCFP/traffic/popular/referrers")
        paths=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/WSG-Lab/ECCFP/traffic/popular/paths")
        
        # ç»„åˆJSONæ•°æ®
        data_json=$(jq -n \
          --argjson views "$views" \
          --argjson clones "$clones" \
          --argjson referrers "$referrers" \
          --argjson paths "$paths" \
          '{views: $views.views, clones: $clones.clones, referrers: $referrers, paths: $paths}')
        
        # è®¾ç½®è¾“å‡º
        echo "data=$data_json" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Process traffic data
      run: |
        # ç¡®å®šä½¿ç”¨å“ªä¸ªæ•°æ®æº
        if [ -n "${{ steps.traffic.outputs.data }}" ]; then
          DATA='${{ steps.traffic.outputs.data }}'
        else
          DATA='${{ steps.api_traffic.outputs.data }}'
        fi
        
        # å¤„ç†æ•°æ®
        mkdir -p traffic-data
        MONTH=$(date -u +"%Y-%m")
        FILE="traffic-data/$MONTH.json"
        JSON_DATA=$(echo "$DATA" | jq -c .)
        
        if [ ! -f "$FILE" ]; then
          echo '{"repository": "WSG-Lab/ECCFP", "weeks":{}}' > "$FILE"
        fi
        
        WEEK_START=$(date -u -d "last monday" +"%Y-%m-%d")
        
        jq --arg week "$WEEK_START" \
           --argjson newData "$JSON_DATA" \
           '.weeks[$week] = $newData' \
           "$FILE" > tmp.json && mv tmp.json "$FILE"

    - name: Commit and push
      run: |
        git config user.name "github-actions"
        git config user.email "actions@users.noreply.github.com"
        git add traffic-data/
        git commit -m "Weekly traffic update for ECCFP ($(date -u +'%Y-%m-%d'))"
        git push

    # å¯é€‰ï¼šæ·»åŠ é€šçŸ¥
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: "ğŸš¨ Traffic monitoring failed for ECCFP repository!"
          })
